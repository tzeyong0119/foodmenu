<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Admin Dashboard</h1>

        <!-- Add/Edit Food Section -->
        <h3 id="formTitle">Add New Food</h3>
        <form id="addEditFoodForm" class="mb-4">
            <div class="mb-3">
                <label for="name" class="form-label">Food Name</label>
                <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-3">
                <label for="price" class="form-label">Price</label>
                <input type="number" class="form-control" id="price" required>
            </div>
            <div class="mb-3">
                <label for="image" class="form-label">Image URL</label>
                <input type="text" class="form-control" id="image" required>
            </div>
            <button type="submit" class="btn btn-success">Save Food</button>
            <button id="cancelEdit" class="btn btn-secondary d-none">Cancel</button>
        </form>

        <!-- Food Management Section -->
        <h3>All Foods</h3>
        <ul id="foodList" class="list-group mb-3">
            <!-- Food items will be dynamically listed here -->
        </ul>

        <!-- Select Today's Menu Section -->
        <h3>Select Today's Menu</h3>
        <ul id="menuList" class="list-group mb-3">
            <!-- Foods to select for today's menu -->
        </ul>
        <button id="saveMenu" class="btn btn-primary">Save Today's Menu</button>
    </div>

    <script>
        const foodList = document.getElementById('foodList');
        const menuList = document.getElementById('menuList');
        const addEditFoodForm = document.getElementById('addEditFoodForm');
        const cancelEditButton = document.getElementById('cancelEdit');
        const saveMenuButton = document.getElementById('saveMenu');
        const formTitle = document.getElementById('formTitle');
        let foods = [];
        let editingFoodId = null;

        // Fetch all foods and populate both sections
        function fetchFoods() {
            fetch('http://localhost:3000/food')
                .then(response => response.json())
                .then(data => {
                    foods = data;
                    renderFoodList();
                    renderMenuList();
                })
                .catch(err => console.error('Error fetching foods:', err));
        }

        // Render the food management list
        function renderFoodList() {
            foodList.innerHTML = '';
            foods.forEach(food => {
                foodList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <strong>${food.name}</strong> - RM${food.price.toFixed(2)}<br>
                            <small>${food.image}</small>
                        </span>
                        <div>
                            <button class="btn btn-warning btn-sm me-2" onclick="editFood(${food.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFood(${food.id})">Delete</button>
                        </div>
                    </li>
                `;
            });
        }

        // Render the menu selection list
        function renderMenuList() {
            menuList.innerHTML = '';
            foods.forEach(food => {
                menuList.innerHTML += `
                    <li class="list-group-item">
                        <input type="checkbox" class="form-check-input me-2" value="${food.id}">
                        ${food.name} - RM${food.price.toFixed(2)}
                    </li>
                `;
            });
        }

        // Add or Edit Food
        addEditFoodForm.addEventListener('submit', event => {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const image = document.getElementById('image').value;

            if (editingFoodId) {
                // Edit existing food
                fetch(`http://localhost:3000/food/${editingFoodId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, image }),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to edit food.');
                        }
                        return response.json();
                    })
                    .then(() => {
                        alert('Food updated successfully!');
                        editingFoodId = null;
                        formTitle.textContent = 'Add New Food';
                        cancelEditButton.classList.add('d-none');
                        addEditFoodForm.reset();
                        fetchFoods();
                    })
                    .catch(err => console.error(err));
            } else {
                // Add new food
                fetch('http://localhost:3000/food', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, image }),
                })
                    .then(response => response.json())
                    .then(() => {
                        alert('Food added successfully!');
                        addEditFoodForm.reset();
                        fetchFoods();
                    })
                    .catch(err => console.error('Error adding food:', err));
            }
        });

        // Edit Food
        function editFood(foodId) {
            const food = foods.find(f => f.id === foodId);
            if (!food) return;

            editingFoodId = foodId;
            formTitle.textContent = 'Edit Food';
            cancelEditButton.classList.remove('d-none');

            // Populate the form with food details
            document.getElementById('name').value = food.name;
            document.getElementById('price').value = food.price;
            document.getElementById('image').value = food.image;
        }

        // Cancel Editing
        cancelEditButton.addEventListener('click', event => {
            event.preventDefault();
            editingFoodId = null;
            formTitle.textContent = 'Add New Food';
            cancelEditButton.classList.add('d-none');
            addEditFoodForm.reset();
        });

        // Delete Food
        function deleteFood(foodId) {
            if (!confirm('Are you sure you want to delete this food?')) return;

            fetch(`http://localhost:3000/food/${foodId}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete food.');
                    }
                    return response.json();
                })
                .then(() => {
                    alert('Food deleted successfully!');
                    fetchFoods();
                })
                .catch(err => console.error('Error deleting food:', err));
        }

        // Save today's menu
        saveMenuButton.addEventListener('click', () => {
            const selectedFoodIds = Array.from(document.querySelectorAll('#menuList input[type="checkbox"]:checked')).map(
                checkbox => parseInt(checkbox.value)
            );

            fetch('http://localhost:3000/menu', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ menu: selectedFoodIds }),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(() => {
                    alert("Today's menu saved!");
                })
                .catch(err => {
                    console.error('Error saving menu:', err);
                    alert('Failed to save menu. Check the console for more details.');
                });
        });

        // Initial fetch
        fetchFoods();
    </script>
</body>
</html>
